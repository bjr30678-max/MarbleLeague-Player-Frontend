<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API è¨ºæ–·å·¥å…·</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            background: #2d2d2d;
        }
        .success { border-left: 4px solid #4ec9b0; }
        .error { border-left: 4px solid #f48771; }
        .warning { border-left: 4px solid #dcdcaa; }
        button {
            padding: 10px 20px;
            margin: 10px 0;
            background: #0e639c;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background: #1177bb;
        }
        pre {
            background: #1e1e1e;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ” API è¨ºæ–·å·¥å…·</h1>
    <p>é€™å€‹å·¥å…·æœƒæ¸¬è©¦ Vite proxy å’Œå¾Œç«¯ API çš„é€£ç·šç‹€æ…‹</p>

    <button onclick="runTests()">ğŸš€ é–‹å§‹æ¸¬è©¦</button>
    <button onclick="clearResults()">ğŸ—‘ï¸ æ¸…é™¤çµæœ</button>

    <div id="results"></div>

    <script>
        const resultsDiv = document.getElementById('results');

        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = message;
            resultsDiv.appendChild(div);
        }

        function clearResults() {
            resultsDiv.innerHTML = '';
        }

        async function testProxyAPI() {
            log('ğŸ“¡ æ¸¬è©¦ 1: é€é Vite Proxy å‘¼å« API...', 'warning');

            try {
                const response = await fetch('/api/auth/liff-login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: 'test-user-123',
                        displayName: 'æ¸¬è©¦ç”¨æˆ¶',
                        pictureUrl: 'https://via.placeholder.com/100',
                        accessToken: 'test-token'
                    })
                });

                const text = await response.text();

                log(`
                    <strong>ç‹€æ…‹ç¢¼:</strong> ${response.status}<br>
                    <strong>éŸ¿æ‡‰:</strong><br>
                    <pre>${text}</pre>
                `, response.ok ? 'success' : 'error');

            } catch (error) {
                log(`
                    <strong>âŒ éŒ¯èª¤:</strong><br>
                    <pre>${error.message}</pre>
                `, 'error');
            }
        }

        async function testDirectAPI() {
            log('ğŸŒ æ¸¬è©¦ 2: ç›´æ¥å‘¼å«å¾Œç«¯ API (æœƒé‡åˆ° CORS)...', 'warning');

            try {
                const response = await fetch('https://api.bjr8888.com/api/auth/liff-login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: 'test-user-123',
                        displayName: 'æ¸¬è©¦ç”¨æˆ¶',
                        pictureUrl: 'https://via.placeholder.com/100',
                        accessToken: 'test-token'
                    })
                });

                const text = await response.text();

                log(`
                    <strong>ç‹€æ…‹ç¢¼:</strong> ${response.status}<br>
                    <strong>éŸ¿æ‡‰:</strong><br>
                    <pre>${text}</pre>
                `, response.ok ? 'success' : 'error');

            } catch (error) {
                log(`
                    <strong>âŒ CORS éŒ¯èª¤ (é æœŸçš„):</strong><br>
                    <pre>${error.message}</pre>
                `, 'warning');
            }
        }

        async function testConfig() {
            log('âš™ï¸ æ¸¬è©¦ 3: æª¢æŸ¥ç’°å¢ƒé…ç½®...', 'warning');

            const checks = [
                { name: 'ç•¶å‰ URL', value: window.location.href },
                { name: 'Hostname', value: window.location.hostname },
                { name: 'Port', value: window.location.port },
                { name: 'Protocol', value: window.location.protocol },
            ];

            const html = checks.map(c => `<strong>${c.name}:</strong> ${c.value}`).join('<br>');
            log(html, 'success');
        }

        async function testHealthCheck() {
            log('ğŸ’Š æ¸¬è©¦ 4: å¾Œç«¯å¥åº·æª¢æŸ¥...', 'warning');

            try {
                const response = await fetch('https://api.bjr8888.com/health', {
                    method: 'GET'
                });

                const text = await response.text();

                log(`
                    <strong>ç‹€æ…‹ç¢¼:</strong> ${response.status}<br>
                    <strong>éŸ¿æ‡‰:</strong><br>
                    <pre>${text || '(ç©ºéŸ¿æ‡‰)'}</pre>
                `, response.ok ? 'success' : 'error');

            } catch (error) {
                log(`
                    <strong>âŒ éŒ¯èª¤:</strong><br>
                    <pre>${error.message}</pre>
                `, 'error');
            }
        }

        async function runTests() {
            clearResults();
            log('ğŸ¯ é–‹å§‹ API è¨ºæ–·æ¸¬è©¦...', 'success');
            log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€', 'info');

            await testConfig();
            log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€', 'info');

            await testProxyAPI();
            log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€', 'info');

            await testDirectAPI();
            log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€', 'info');

            await testHealthCheck();
            log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€', 'info');

            log('âœ… æ¸¬è©¦å®Œæˆï¼', 'success');
        }

        // é é¢è¼‰å…¥æ™‚é¡¯ç¤ºèªªæ˜
        log(`
            <strong>ä½¿ç”¨èªªæ˜:</strong><br>
            1. ç¢ºä¿é–‹ç™¼ä¼ºæœå™¨æ­£åœ¨é‹è¡Œ (npm run dev)<br>
            2. é»æ“Š "é–‹å§‹æ¸¬è©¦" æŒ‰éˆ•<br>
            3. æŸ¥çœ‹æ¸¬è©¦çµæœï¼Œæ‰¾å‡ºå•é¡Œæ‰€åœ¨<br><br>
            <strong>é æœŸçµæœ:</strong><br>
            - æ¸¬è©¦ 1 (Proxy): æ‡‰è©²æˆåŠŸæˆ–è¿”å›å¾Œç«¯éŒ¯èª¤è¨Šæ¯ï¼ˆä¸æ˜¯ 404ï¼‰<br>
            - æ¸¬è©¦ 2 (Direct): æ‡‰è©²é‡åˆ° CORS éŒ¯èª¤ï¼ˆé€™æ˜¯æ­£å¸¸çš„ï¼‰<br>
            - æ¸¬è©¦ 3 (Config): é¡¯ç¤ºç•¶å‰é…ç½®<br>
            - æ¸¬è©¦ 4 (Health): æª¢æŸ¥å¾Œç«¯æ˜¯å¦åœ¨ç·š
        `, 'warning');
    </script>
</body>
</html>
